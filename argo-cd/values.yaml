repoServer:
  volumes:
   - name: argocd-cmp-cm
     configMap:
       name: argocd-cmp-cm
   - name: cmp-tmp
     emptyDir: {}

  extraContainers:
  - name: gomplate-helm
    image: pltsciart/helm-gomplate:latest
    command: [/var/run/argocd/argocd-cmp-server]
    args: [--loglevel, debug]
    securityContext:
      runAsNonRoot: true
      runAsUser: 999
    volumeMounts:
      - mountPath: /var/run/argocd
        name: var-files
      - mountPath: /home/argocd/cmp-server/plugins
        name: plugins
      # Remove this volumeMount if you've chosen to bake the config file into the sidecar image.
      - mountPath: /home/argocd/cmp-server/config/plugin.yaml
        subPath: helm-gomplate.yaml
        name: argocd-cmp-cm


configs:
  cmp:
    create: true
    plugins:
      helm-gomplate:
        init:
          command: ["sh", "-c"]
          args:
           - |
             echo "pulling chart $ARGOCD_ENV_CHART_NAME from $ARGOCD_ENV_CHART_REPO version $ARGOCD_ENV_CHART_VERSION"
             helm pull $ARGOCD_ENV_CHART_NAME --repo $ARGOCD_ENV_CHART_REPO --version $ARGOCD_ENV_CHART_VERSION --untar --untardir $ARGOCD_ENV_CHART_PATH
        generate:
         command: ["sh", "-c"]
         args:
           - |
             gomplate -c .=$ARGOCD_ENV_CLUSTER_VALUES_FILE -f $ARGOCD_ENV_CHART_PATH/values.gotmpl.yaml -o $ARGOCD_ENV_CHART_PATH/values.yaml | helm template $ARGOCD_ENV_CHART_PATH $ARGOCD_ENV_VALUE_FILES